<!DOCTYPE html>
<html lang="zh-CN" class="h-full bg-slate-950">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Event Relay Hub Â· äº‹ä»¶æ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="h-full text-slate-100">
    <main class="mx-auto flex min-h-full w-full max-w-5xl flex-col gap-8 px-4 py-8 sm:px-6 lg:px-8">
      <header class="space-y-2">
        <h1 class="text-3xl font-bold tracking-tight">äº‹ä»¶æ§åˆ¶å°</h1>
        <p class="max-w-2xl text-sm text-slate-300">
          æŸ¥çœ‹äº‹ä»¶ã€æ‰§è¡Œé‡æ”¾ã€å¤„ç†æ­»ä¿¡é˜Ÿåˆ—ã€‚æ”¯æŒç­›é€‰ã€åˆ†é¡µã€æ‰¹é‡æ“ä½œï¼Œæ‰€æœ‰æŒ‰é’®å‡ç¬¦åˆé”®ç›˜ä¸å±å¹•é˜…è¯»å™¨è§„èŒƒã€‚
        </p>
        <div class="flex flex-wrap items-center gap-3 text-sm">
          <a href="/" class="inline-flex items-center gap-2 text-blue-300 underline hover:text-blue-100" aria-label="è¿”å›æ¬¢è¿é¡µ">
            â† è¿”å›æ¬¢è¿é¡µ
          </a>
          <a href="/console/signatures" class="inline-flex items-center gap-2 text-blue-300 underline hover:text-blue-100" aria-label="ç­¾åæ¨¡æ¿é…ç½®">
            ç­¾åé…ç½®
          </a>
        </div>
      </header>

      <section id="status" aria-live="polite" class="hidden rounded-lg border border-slate-700 bg-slate-800/60 p-4 text-sm"></section>

      <section id="statsPanel" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4" aria-live="polite">
        <article class="rounded-xl border border-slate-800 bg-slate-900/70 p-4">
          <p class="text-xs text-slate-400">æ€»äº‹ä»¶</p>
          <p id="stat-total" class="mt-1 text-2xl font-semibold">-</p>
        </article>
        <article class="rounded-xl border border-slate-800 bg-slate-900/70 p-4">
          <p class="text-xs text-slate-400">24 å°æ—¶æ–°å¢</p>
          <p id="stat-recent" class="mt-1 text-2xl font-semibold">-</p>
        </article>
        <article class="rounded-xl border border-slate-800 bg-slate-900/70 p-4">
          <p class="text-xs text-slate-400">ç­¾åæˆåŠŸç‡</p>
          <p id="stat-sig" class="mt-1 text-2xl font-semibold">-</p>
        </article>
        <article class="rounded-xl border border-slate-800 bg-slate-900/70 p-4">
          <p class="text-xs text-slate-400">æ­»ä¿¡é˜Ÿåˆ—</p>
          <p id="stat-dlq" class="mt-1 text-2xl font-semibold">-</p>
        </article>
      </section>

      <!-- Events Section -->
      <section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <header class="mb-4 flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
          <div>
            <h2 class="text-xl font-semibold">äº‹ä»¶åˆ—è¡¨</h2>
            <p class="text-xs text-slate-400">æ”¯æŒæŒ‰æ¥æºã€ç±»å‹ã€ç­¾åçŠ¶æ€ä¸æ—¶é—´èŒƒå›´ç­›é€‰ï¼Œç»“æœåˆ†é¡µæ˜¾ç¤ºï¼Œå¯æ‰¹é‡é‡æ”¾ã€‚</p>
          </div>
          <button id="refreshEvents" class="self-start rounded-full bg-slate-700 px-4 py-2 text-xs font-semibold text-white transition hover:bg-slate-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900">
            åˆ·æ–°æ•°æ®
          </button>
        </header>

        <form id="eventsFilterForm" class="grid gap-4 rounded-xl border border-slate-700 bg-slate-900/80 p-4 text-xs text-slate-200" aria-label="äº‹ä»¶ç­›é€‰è¡¨å•">
          <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
            <label class="flex flex-col gap-1">
              <span>æ¥æº Source</span>
              <input type="text" name="source" class="rounded-lg border border-slate-600 bg-slate-950 px-3 py-2 focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" placeholder="stripe / github ..." />
            </label>
            <label class="flex flex-col gap-1">
              <span>äº‹ä»¶ç±»å‹ Event Type</span>
              <input type="text" name="event_type" class="rounded-lg border border-slate-600 bg-slate-950 px-3 py-2 focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" placeholder="payment.succeeded ..." />
            </label>
            <label class="flex flex-col gap-1">
              <span>ç­¾åçŠ¶æ€ Signature</span>
              <select name="signature_valid" class="rounded-lg border border-slate-600 bg-slate-950 px-3 py-2 focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400">
                <option value="">ä¸é™</option>
                <option value="true">ä»…ç­¾åé€šè¿‡</option>
                <option value="false">ä»…ç­¾åå¤±è´¥</option>
              </select>
            </label>
            <label class="flex flex-col gap-1">
              <span>èµ·å§‹æ—¶é—´ Start</span>
              <input type="datetime-local" name="start_time" class="rounded-lg border border-slate-600 bg-slate-950 px-3 py-2 focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" />
            </label>
            <label class="flex flex-col gap-1">
              <span>ç»“æŸæ—¶é—´ End</span>
              <input type="datetime-local" name="end_time" class="rounded-lg border border-slate-600 bg-slate-950 px-3 py-2 focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" />
            </label>
            <label class="flex flex-col gap-1">
              <span>æ¯é¡µæ•°é‡ Page Size</span>
              <select name="page_size" class="rounded-lg border border-slate-600 bg-slate-950 px-3 py-2 focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </label>
          </div>
          <div class="flex flex-wrap items-center gap-3">
            <button type="submit" class="rounded-lg bg-blue-600 px-4 py-2 text-xs font-semibold text-white hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900">
              åº”ç”¨ç­›é€‰
            </button>
            <button type="button" id="resetEventsFilters" class="rounded-lg border border-slate-600 px-4 py-2 text-xs font-semibold text-slate-300 hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900">
              é‡ç½®
            </button>
          </div>
        </form>

        <div class="mt-4 flex flex-wrap items-center justify-between gap-3 text-xs" aria-live="polite">
          <div class="flex flex-wrap items-center gap-3">
            <button id="bulkReplayEvents" class="rounded-lg bg-emerald-600 px-4 py-2 font-semibold text-white transition hover:bg-emerald-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900" disabled>
              æ‰¹é‡é‡æ”¾æ‰€é€‰äº‹ä»¶
            </button>
            <label class="flex items-center gap-2 text-slate-200">
              <span>æ‰¹é‡ç›®æ ‡ URLï¼ˆå¯é€‰ï¼‰</span>
              <input type="url" id="bulkEventsTarget" class="w-56 rounded-lg border border-slate-600 bg-slate-950 px-3 py-2 focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" placeholder="é»˜è®¤ä½¿ç”¨ç³»ç»Ÿè®¾ç½®" />
            </label>
          </div>
          <span id="eventsSelectionSummary" class="text-slate-400">å·²é€‰ 0 æ¡äº‹ä»¶</span>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full min-w-full divide-y divide-slate-800 text-left text-sm">
            <thead class="bg-slate-900/80 text-xs uppercase tracking-wide text-slate-400">
              <tr>
                <th scope="col" class="w-12 px-4 py-2">
                  <input id="eventsSelectAll" type="checkbox" class="h-4 w-4 rounded border border-slate-500 text-blue-500 focus:ring-blue-400" aria-label="å…¨é€‰æ­¤é¡µäº‹ä»¶" />
                </th>
                <th scope="col" class="px-4 py-2">ID</th>
                <th scope="col" class="px-4 py-2">æ¥æº</th>
                <th scope="col" class="px-4 py-2">ç±»å‹</th>
                <th scope="col" class="px-4 py-2">æ—¶é—´</th>
                <th scope="col" class="px-4 py-2">ç­¾å</th>
                <th scope="col" class="px-4 py-2">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="eventsTable" class="divide-y divide-slate-800"></tbody>
          </table>
        </div>
        <footer id="eventsPagination" class="mt-4 flex flex-wrap items-center justify-between gap-3 text-xs text-slate-400"></footer>
      </section>

      <!-- DLQ Section -->
      <section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <header class="mb-4 flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
          <div>
            <h2 class="text-xl font-semibold">æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰</h2>
            <p class="text-xs text-slate-400">é’ˆå¯¹è½¬å‘å¤±è´¥çš„äº‹ä»¶ï¼Œå¯å¤šé€‰è¿›è¡Œé‡è¯•æˆ–åˆ é™¤ï¼Œäº¦æ”¯æŒä¸€é”®æ¸…ç©ºã€‚</p>
          </div>
          <button id="refreshDlq" class="rounded-full bg-slate-700 px-4 py-2 text-xs font-semibold text-white transition hover:bg-slate-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900">
            åˆ·æ–°é˜Ÿåˆ—
          </button>
        </header>

        <form id="dlqFilterForm" class="mb-4 grid gap-3 text-xs sm:grid-cols-2 lg:grid-cols-4" novalidate>
          <label class="flex flex-col gap-1">
            <span class="font-semibold text-slate-300">äº‹ä»¶æ¥æº</span>
            <input name="source" type="text" placeholder="å¦‚ï¼šgithub" class="rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </label>
          <label class="flex flex-col gap-1">
            <span class="font-semibold text-slate-300">äº‹ä»¶ç±»å‹</span>
            <input name="event_type" type="text" placeholder="å¦‚ï¼šinvoice.paid" class="rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </label>
          <label class="flex flex-col gap-1">
            <span class="font-semibold text-slate-300">æœ€å°é‡è¯•æ¬¡æ•°</span>
            <input name="min_retry" type="number" min="0" step="1" placeholder="0" class="rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </label>
          <label class="flex flex-col gap-1">
            <span class="font-semibold text-slate-300">å…³é”®å­—æœç´¢</span>
            <input name="search" type="text" placeholder="åŒ¹é…åŸå› /é”™è¯¯/æ¥æº" class="rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </label>
          <div class="flex items-end gap-2">
            <button type="submit" class="rounded-lg bg-blue-600 px-4 py-2 font-semibold text-white hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900">
              åº”ç”¨ç­›é€‰
            </button>
            <button type="button" id="resetDlqFilters" class="rounded-lg border border-slate-600 px-4 py-2 font-semibold text-slate-200 hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900">
              é‡ç½®
            </button>
            <span class="text-slate-500" aria-live="polite">ç­›é€‰æ¡ä»¶ä¼šè‡ªåŠ¨ä¿å­˜ï¼Œä¸‹æ¬¡æ‰“å¼€è‡ªåŠ¨æ¢å¤ã€‚</span>
          </div>
        </form>

        <div class="flex flex-wrap items-center gap-3 text-xs" aria-live="polite">
          <button id="bulkReplayDlq" class="rounded-lg bg-emerald-600 px-4 py-2 font-semibold text-white transition hover:bg-emerald-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900" disabled>
            æ‰¹é‡é‡è¯•æ‰€é€‰
          </button>
          <button id="bulkDeleteDlq" class="rounded-lg border border-slate-600 px-4 py-2 font-semibold text-slate-200 transition hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900" disabled>
            æ‰¹é‡åˆ é™¤æ‰€é€‰
          </button>
          <button id="clearDlq" class="rounded-lg bg-red-600 px-4 py-2 font-semibold text-white transition hover:bg-red-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900">
            æ¸…ç©ºé˜Ÿåˆ—
          </button>
          <span id="dlqSelectionSummary" class="text-slate-400">å·²é€‰ 0 æ¡æ­»ä¿¡</span>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full min-w-full divide-y divide-slate-800 text-left text-sm">
            <thead class="bg-slate-900/80 text-xs uppercase tracking-wide text-slate-400">
              <tr>
                <th class="w-12 px-4 py-2">
                  <input id="dlqSelectAll" type="checkbox" class="h-4 w-4 rounded border border-slate-500 text-blue-500 focus:ring-blue-400" aria-label="å…¨é€‰æ­¤é¡µæ­»ä¿¡" />
                </th>
                <th class="px-4 py-2">DLQ ID</th>
                <th class="px-4 py-2">äº‹ä»¶</th>
                <th class="px-4 py-2">é‡è¯•æ¬¡æ•°</th>
                <th class="px-4 py-2">æœ€åé”™è¯¯</th>
                <th class="px-4 py-2">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="dlqTable" class="divide-y divide-slate-800"></tbody>
          </table>
        </div>
        <footer id="dlqPagination" class="mt-4 flex flex-wrap items-center justify-between gap-3 text-xs text-slate-400"></footer>
      </section>
    </main>

    <template id="event-row">
      <tr class="bg-slate-900/40 hover:bg-slate-900/60">
        <td class="px-4 py-3"><input type="checkbox" class="event-checkbox h-4 w-4 rounded border border-slate-500 text-blue-500 focus:ring-blue-400" aria-label="é€‰æ‹©äº‹ä»¶" /></td>
        <td class="px-4 py-3 font-mono text-xs"></td>
        <td class="px-4 py-3 text-xs"></td>
        <td class="px-4 py-3 text-xs"></td>
        <td class="px-4 py-3 text-xs text-slate-300"></td>
        <td class="px-4 py-3 text-xs"></td>
        <td class="px-4 py-3">
          <form class="flex flex-col gap-2 text-xs" novalidate>
            <label class="sr-only">ç›®æ ‡ URL</label>
            <input type="url" class="w-full rounded-md border border-slate-700 bg-slate-900 px-2 py-1 focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" placeholder="é»˜è®¤ä½¿ç”¨é…ç½® URL" />
            <button type="submit" class="inline-flex items-center justify-center rounded-md bg-blue-500 px-2 py-1 font-semibold text-white transition hover:bg-blue-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900">
              å•æ¡é‡æ”¾
            </button>
          </form>
        </td>
      </tr>
    </template>

    <template id="dlq-row">
      <tr class="bg-slate-900/40 hover:bg-slate-900/60">
        <td class="px-4 py-3"><input type="checkbox" class="dlq-checkbox h-4 w-4 rounded border border-slate-500 text-blue-500 focus:ring-blue-400" aria-label="é€‰æ‹©æ­»ä¿¡" /></td>
        <td class="px-4 py-3 font-mono text-xs"></td>
        <td class="px-4 py-3 text-xs"></td>
        <td class="px-4 py-3 text-xs"></td>
        <td class="px-4 py-3 text-xs text-red-300"></td>
        <td class="px-4 py-3 text-xs">
          <div class="flex flex-wrap gap-2">
            <button data-action="replay" class="rounded-md bg-emerald-500 px-2 py-1 text-white hover:bg-emerald-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900">
              é‡è¯•
            </button>
            <button data-action="delete" class="rounded-md bg-slate-700 px-2 py-1 text-white hover:bg-slate-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900">
              åˆ é™¤
            </button>
          </div>
        </td>
      </tr>
    </template>

    <script>
      const statusEl = document.getElementById('status');
      const eventsTable = document.getElementById('eventsTable');
      const dlqTable = document.getElementById('dlqTable');
      const eventRowTemplate = document.getElementById('event-row');
      const dlqRowTemplate = document.getElementById('dlq-row');
      const statTotalEl = document.getElementById('stat-total');
      const statRecentEl = document.getElementById('stat-recent');
      const statSigEl = document.getElementById('stat-sig');
      const statDlqEl = document.getElementById('stat-dlq');

      const refreshEventsBtn = document.getElementById('refreshEvents');
      const refreshDlqBtn = document.getElementById('refreshDlq');
      const eventsFilterForm = document.getElementById('eventsFilterForm');
      const resetEventsFiltersBtn = document.getElementById('resetEventsFilters');
      const eventsSelectAll = document.getElementById('eventsSelectAll');
      const dlqSelectAll = document.getElementById('dlqSelectAll');
      const bulkReplayEventsBtn = document.getElementById('bulkReplayEvents');
      const bulkEventsTargetInput = document.getElementById('bulkEventsTarget');
      const eventsSelectionSummary = document.getElementById('eventsSelectionSummary');
      const eventsPagination = document.getElementById('eventsPagination');
      const bulkReplayDlqBtn = document.getElementById('bulkReplayDlq');
      const bulkDeleteDlqBtn = document.getElementById('bulkDeleteDlq');
      const clearDlqBtn = document.getElementById('clearDlq');
      const dlqSelectionSummary = document.getElementById('dlqSelectionSummary');
      const dlqPagination = document.getElementById('dlqPagination');
      const dlqFilterForm = document.getElementById('dlqFilterForm');
      const resetDlqFiltersBtn = document.getElementById('resetDlqFilters');

      const STORAGE_KEY = 'erh_events_filters_v1';
      const DLQ_STORAGE_KEY = 'erh_dlq_filters_v1';
      const savedState = (() => {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        } catch (error) {
          return {};
        }
      })();
      const savedDlqState = (() => {
        try {
          return JSON.parse(localStorage.getItem(DLQ_STORAGE_KEY) || '{}');
        } catch (error) {
          return {};
        }
      })();

      const eventsState = {
        filters: {
          source: savedState.filters?.source || '',
          eventType: savedState.filters?.eventType || '',
          signatureValid: savedState.filters?.signatureValid || '',
          startTime: savedState.filters?.startTime || '',
          endTime: savedState.filters?.endTime || '',
        },
        page: savedState.page || 1,
        pageSize: savedState.pageSize || 20,
        total: 0,
        items: [],
        selected: new Set(),
      };

      const dlqState = {
        page: savedDlqState.page || 1,
        pageSize: savedDlqState.pageSize || 20,
        total: 0,
        items: [],
        selected: new Set(),
        filters: {
          source: savedDlqState.filters?.source || '',
          eventType: savedDlqState.filters?.eventType || '',
          search: savedDlqState.filters?.search || '',
          minRetry: savedDlqState.filters?.minRetry ?? '',
        },
        loading: false,
      };

      const statsState = {
        loading: false,
        data: null,
      };

      function showStatus(message, variant = 'success') {
        statusEl.textContent = message;
        statusEl.classList.remove('hidden');
        statusEl.classList.toggle('border-green-500', variant === 'success');
        statusEl.classList.toggle('text-green-200', variant === 'success');
        statusEl.classList.toggle('border-red-500', variant === 'error');
        statusEl.classList.toggle('text-red-200', variant === 'error');
      }

      function setButtonLoading(button, isLoading) {
        if (!button) return;
        button.disabled = isLoading;
        button.setAttribute('aria-busy', isLoading ? 'true' : 'false');
      }

      function persistEventsState() {
        const payload = {
          filters: eventsState.filters,
          page: eventsState.page,
          pageSize: eventsState.pageSize,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      }

      function persistDlqState() {
        const payload = {
          filters: dlqState.filters,
          page: dlqState.page,
          pageSize: dlqState.pageSize,
        };
        localStorage.setItem(DLQ_STORAGE_KEY, JSON.stringify(payload));
      }

      async function fetchJson(url, options = {}) {
        const response = await fetch(url, options);
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.detail || 'è¯·æ±‚å¤±è´¥');
        }
        return response.json();
      }

      function toInputValue(value) {
        if (!value) return '';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '';
        const offset = date.getTimezoneOffset();
        const local = new Date(date.getTime() - offset * 60000);
        return local.toISOString().slice(0, 16);
      }

      function buildEventsParams() {
        const params = new URLSearchParams();
        if (eventsState.filters.source) params.set('source', eventsState.filters.source);
        if (eventsState.filters.eventType) params.set('event_type', eventsState.filters.eventType);
        if (eventsState.filters.signatureValid) params.set('signature_valid', eventsState.filters.signatureValid);
        if (eventsState.filters.startTime) params.set('start_time', eventsState.filters.startTime);
        if (eventsState.filters.endTime) params.set('end_time', eventsState.filters.endTime);
        params.set('page', String(eventsState.page));
        params.set('page_size', String(eventsState.pageSize));
        return params;
      }

      function syncEventsFilterForm() {
        eventsFilterForm.elements['source'].value = eventsState.filters.source;
        eventsFilterForm.elements['event_type'].value = eventsState.filters.eventType;
        eventsFilterForm.elements['signature_valid'].value = eventsState.filters.signatureValid;
        eventsFilterForm.elements['start_time'].value = toInputValue(eventsState.filters.startTime);
        eventsFilterForm.elements['end_time'].value = toInputValue(eventsState.filters.endTime);
        eventsFilterForm.elements['page_size'].value = String(eventsState.pageSize);
      }

      function syncDlqFilterForm() {
        if (!dlqFilterForm) return;
        dlqFilterForm.elements['source'].value = dlqState.filters.source;
        dlqFilterForm.elements['event_type'].value = dlqState.filters.eventType;
        dlqFilterForm.elements['search'].value = dlqState.filters.search;
        dlqFilterForm.elements['min_retry'].value = dlqState.filters.minRetry === '' ? '' : String(dlqState.filters.minRetry);
      }

      async function loadEvents() {
        try {
          const params = buildEventsParams();
          const data = await fetchJson(`/api/events/search?${params.toString()}`);
          eventsState.total = data.total;
          eventsState.page = data.page;
          eventsState.pageSize = data.page_size;
          eventsState.items = data.items || [];
          const totalPages = Math.max(1, Math.ceil((data.total || 0) / data.page_size));
          if (eventsState.page > totalPages && totalPages > 0) {
            eventsState.page = totalPages;
            persistEventsState();
            return loadEvents();
          }
          syncEventsFilterForm();
          renderEvents();
          persistEventsState();
        } catch (error) {
          showStatus(error.message || 'åŠ è½½äº‹ä»¶å¤±è´¥', 'error');
        }
      }

      async function loadDlq() {
        dlqState.loading = true;
        renderDlq();
        try {
          const params = new URLSearchParams({
            page: String(dlqState.page),
            page_size: String(dlqState.pageSize),
          });
          if (dlqState.filters.source) params.set('source', dlqState.filters.source);
          if (dlqState.filters.eventType) params.set('event_type', dlqState.filters.eventType);
          if (dlqState.filters.search) params.set('search', dlqState.filters.search);
          if (dlqState.filters.minRetry !== '' && Number.isFinite(Number(dlqState.filters.minRetry))) {
            params.set('min_retry', String(dlqState.filters.minRetry));
          }

          const data = await fetchJson(`/api/dlq?${params.toString()}`);
          const totalPages = Math.max(1, Math.ceil((data.total || 0) / data.page_size));
          if (dlqState.page > totalPages && totalPages > 0) {
            dlqState.page = totalPages;
            persistDlqState();
            dlqState.loading = false;
            return loadDlq();
          }

          dlqState.total = data.total;
          dlqState.page = data.page;
          dlqState.pageSize = data.page_size;
          dlqState.items = data.items || [];
          const visibleIds = new Set(dlqState.items.map((item) => item.id));
          dlqState.selected.forEach((id) => {
            if (!visibleIds.has(id)) {
              dlqState.selected.delete(id);
            }
          });
          syncDlqFilterForm();
          persistDlqState();
        } catch (error) {
          showStatus(error.message || 'åŠ è½½æ­»ä¿¡é˜Ÿåˆ—å¤±è´¥', 'error');
        } finally {
          dlqState.loading = false;
          renderDlq();
        }
      }

      async function loadStats() {
        try {
          statsState.loading = true;
          const data = await fetchJson('/api/stats');
          statsState.data = data;
          renderStats();
        } catch (error) {
          statTotalEl.textContent = '-';
          statRecentEl.textContent = '-';
          statSigEl.textContent = '-';
          statDlqEl.textContent = '-';
        } finally {
          statsState.loading = false;
        }
      }

      function renderEvents() {
        eventsTable.innerHTML = '';
        const currentIds = new Set(eventsState.items.map((item) => item.id));
        eventsState.selected.forEach((id) => {
          if (!currentIds.has(id)) return;
        });

        eventsState.items.forEach((event) => {
          const row = eventRowTemplate.content.firstElementChild.cloneNode(true);
          const cells = row.querySelectorAll('td');
          const checkbox = row.querySelector('.event-checkbox');
          checkbox.checked = eventsState.selected.has(event.id);
          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              eventsState.selected.add(event.id);
            } else {
              eventsState.selected.delete(event.id);
            }
            updateEventsSelectionSummary();
            syncEventsSelectAll();
          });

          cells[1].textContent = `#${event.id}`;
          cells[2].textContent = event.source;
          cells[3].textContent = event.event_type || '-';
          cells[4].textContent = new Date(event.created_at).toLocaleString();
          cells[5].textContent = event.signature_valid ? 'âœ… å·²é€šè¿‡' : 'âš ï¸ æœªéªŒè¯';

          const form = row.querySelector('form');
          const input = form.querySelector('input[type="url"]');
          const submitBtn = form.querySelector('button[type="submit"]');
          form.addEventListener('submit', async (evt) => {
            evt.preventDefault();
            setButtonLoading(submitBtn, true);
            try {
              const params = input.value ? `?target_url=${encodeURIComponent(input.value)}` : '';
              const data = await fetchJson(`/api/events/${event.id}/replay${params}`, { method: 'POST' });
              const note = typeof data.notes === 'string' ? data.notes : '';
              showStatus(
                [data.message || `äº‹ä»¶ #${event.id} å·²å¤„ç†ã€‚`, note].filter(Boolean).join(' '),
                data.success ? 'success' : 'error',
              );
              loadEvents();
              loadDlq();
              loadStats();
            } catch (error) {
              showStatus(error.message || 'é‡æ”¾å¤±è´¥', 'error');
            } finally {
              setButtonLoading(submitBtn, false);
            }
          });

          eventsTable.appendChild(row);
        });

        updateEventsSelectionSummary();
        syncEventsSelectAll();
        renderEventsPagination();
      }

      function updateEventsSelectionSummary() {
        const count = eventsState.selected.size;
        eventsSelectionSummary.textContent = `å·²é€‰ ${count} æ¡äº‹ä»¶`;
        bulkReplayEventsBtn.disabled = count === 0;
      }

      function syncEventsSelectAll() {
        const displayedIds = eventsState.items.map((item) => item.id);
        if (displayedIds.length === 0) {
          eventsSelectAll.checked = false;
          eventsSelectAll.indeterminate = false;
          return;
        }
        const selectedOnPage = displayedIds.filter((id) => eventsState.selected.has(id)).length;
        eventsSelectAll.checked = selectedOnPage === displayedIds.length;
        eventsSelectAll.indeterminate = selectedOnPage > 0 && selectedOnPage < displayedIds.length;
      }

      function renderEventsPagination() {
        eventsPagination.innerHTML = '';
        const totalPages = Math.max(1, Math.ceil(eventsState.total / eventsState.pageSize));
        const info = document.createElement('span');
        info.textContent = `ç¬¬ ${eventsState.page} / ${totalPages} é¡µï¼Œå…± ${eventsState.total} æ¡`;
        eventsPagination.appendChild(info);

        const controls = document.createElement('div');
        controls.className = 'flex items-center gap-2';

        const prev = document.createElement('button');
        prev.textContent = 'ä¸Šä¸€é¡µ';
        prev.disabled = eventsState.page === 1;
        prev.className = 'rounded-lg border border-slate-600 px-3 py-1.5 text-xs hover:bg-slate-800 disabled:cursor-not-allowed disabled:border-slate-700 disabled:text-slate-500';
        prev.addEventListener('click', () => {
          eventsState.page = Math.max(1, eventsState.page - 1);
          loadEvents();
        });

        const next = document.createElement('button');
        next.textContent = 'ä¸‹ä¸€é¡µ';
        next.disabled = eventsState.page >= totalPages;
        next.className = 'rounded-lg border border-slate-600 px-3 py-1.5 text-xs hover:bg-slate-800 disabled:cursor-not-allowed disabled:border-slate-700 disabled:text-slate-500';
        next.addEventListener('click', () => {
          eventsState.page = Math.min(totalPages, eventsState.page + 1);
          loadEvents();
        });

        controls.appendChild(prev);
        controls.appendChild(next);
        eventsPagination.appendChild(controls);
      }

      function renderDlq() {
        dlqTable.innerHTML = '';
        if (dlqState.loading) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = '<td class="px-4 py-4 text-center text-xs text-slate-400" colspan="6">åŠ è½½æ­»ä¿¡ä¸­â€¦</td>';
          dlqTable.appendChild(emptyRow);
          updateDlqSelectionSummary();
          syncDlqSelectAll();
          renderDlqPagination();
          return;
        }

        const displayedIds = new Set(dlqState.items.map((item) => item.id));
        const staleSelection = [];
        dlqState.selected.forEach((id) => {
          if (!displayedIds.has(id)) staleSelection.push(id);
        });
        staleSelection.forEach((id) => dlqState.selected.delete(id));

        if (!dlqState.items.length) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = '<td class="px-4 py-4 text-center text-xs text-slate-400" colspan="6">ğŸ‰ å½“å‰æ²¡æœ‰æ­»ä¿¡äº‹ä»¶ã€‚</td>';
          dlqTable.appendChild(emptyRow);
        } else {
          dlqState.items.forEach((item) => {
            const row = dlqRowTemplate.content.firstElementChild.cloneNode(true);
            const cells = row.querySelectorAll('td');
            const checkbox = row.querySelector('.dlq-checkbox');
            checkbox.checked = dlqState.selected.has(item.id);
            checkbox.addEventListener('change', () => {
              if (checkbox.checked) dlqState.selected.add(item.id);
              else dlqState.selected.delete(item.id);
              updateDlqSelectionSummary();
              syncDlqSelectAll();
            });

            cells[1].textContent = `DLQ-${item.id}`;
            cells[2].innerHTML = `<div class="space-y-1"><div>${item.source} / ${item.event_type || '-'} (#${item.event_id})</div><div class="font-mono text-xs text-slate-400">${item.payload_preview || ''}</div></div>`;
            cells[3].textContent = item.retry_count;
            cells[4].textContent = item.last_error || item.reason || '-';

            const replayBtn = row.querySelector('button[data-action="replay"]');
            const deleteBtn = row.querySelector('button[data-action="delete"]');

            replayBtn.addEventListener('click', async () => {
              setButtonLoading(replayBtn, true);
              try {
                const data = await fetchJson(`/api/dlq/${item.id}/replay`, { method: 'POST' });
                const note = typeof data.notes === 'string' ? data.notes : '';
                showStatus(
                  [data.message || `æ­»ä¿¡ DLQ-${item.id} å·²å¤„ç†ã€‚`, note].filter(Boolean).join(' '),
                  data.success ? 'success' : 'error',
                );
                dlqState.selected.delete(item.id);
                loadEvents();
                loadDlq();
                loadStats();
              } catch (error) {
                showStatus(error.message || 'é‡æ”¾å¤±è´¥', 'error');
              } finally {
                setButtonLoading(replayBtn, false);
              }
            });

            deleteBtn.addEventListener('click', async () => {
              if (!confirm(`ç¡®å®šåˆ é™¤ DLQ-${item.id} å—ï¼Ÿ`)) return;
              try {
                await fetchJson(`/api/dlq/${item.id}`, { method: 'DELETE' });
                showStatus(`æ­»ä¿¡ DLQ-${item.id} å·²åˆ é™¤ã€‚`);
                dlqState.selected.delete(item.id);
                loadDlq();
              } catch (error) {
                showStatus(error.message || 'åˆ é™¤å¤±è´¥', 'error');
              }
            });

            dlqTable.appendChild(row);
          });
        }

        updateDlqSelectionSummary();
        syncDlqSelectAll();
        renderDlqPagination();
      }

      function renderStats() {
        if (!statsState.data) return;
        const data = statsState.data;
        statTotalEl.textContent = data.total_events ?? '-';
        statRecentEl.textContent = data.recent_24h ?? '-';
        statSigEl.textContent = data.signature_success_rate != null ? `${data.signature_success_rate.toFixed(1)}%` : '-';
        statDlqEl.textContent = data.dead_letters ?? '-';
      }

      function updateDlqSelectionSummary() {
        if (dlqState.loading) {
          dlqSelectionSummary.textContent = 'æ­»ä¿¡åŠ è½½ä¸­â€¦';
          bulkReplayDlqBtn.disabled = true;
          bulkDeleteDlqBtn.disabled = true;
          return;
        }
        const count = dlqState.selected.size;
        dlqSelectionSummary.textContent = `å·²é€‰ ${count} æ¡æ­»ä¿¡`;
        bulkReplayDlqBtn.disabled = count === 0;
        bulkDeleteDlqBtn.disabled = count === 0;
      }

      function syncDlqSelectAll() {
        const displayedIds = dlqState.items.map((item) => item.id);
        if (displayedIds.length === 0) {
          dlqSelectAll.checked = false;
          dlqSelectAll.indeterminate = false;
          return;
        }
        const selectedOnPage = displayedIds.filter((id) => dlqState.selected.has(id)).length;
        dlqSelectAll.checked = selectedOnPage === displayedIds.length;
        dlqSelectAll.indeterminate = selectedOnPage > 0 && selectedOnPage < displayedIds.length;
      }

      function renderDlqPagination() {
        dlqPagination.innerHTML = '';
        const totalPages = Math.max(1, Math.ceil(dlqState.total / dlqState.pageSize));
        const info = document.createElement('span');
        info.textContent = `ç¬¬ ${dlqState.page} / ${totalPages} é¡µï¼Œå…± ${dlqState.total} æ¡`;
        dlqPagination.appendChild(info);

        const controls = document.createElement('div');
        controls.className = 'flex items-center gap-2';

        const prev = document.createElement('button');
        prev.textContent = 'ä¸Šä¸€é¡µ';
        prev.disabled = dlqState.page === 1;
        prev.className = 'rounded-lg border border-slate-600 px-3 py-1.5 text-xs hover:bg-slate-800 disabled:cursor-not-allowed disabled:border-slate-700 disabled:text-slate-500';
        prev.addEventListener('click', () => {
          dlqState.page = Math.max(1, dlqState.page - 1);
          loadDlq();
        });

        const next = document.createElement('button');
        next.textContent = 'ä¸‹ä¸€é¡µ';
        next.disabled = dlqState.page >= totalPages;
        next.className = 'rounded-lg border border-slate-600 px-3 py-1.5 text-xs hover:bg-slate-800 disabled:cursor-not-allowed disabled:border-slate-700 disabled:text-slate-500';
        next.addEventListener('click', () => {
          dlqState.page = Math.min(totalPages, dlqState.page + 1);
          loadDlq();
        });

        controls.appendChild(prev);
        controls.appendChild(next);
        dlqPagination.appendChild(controls);
      }

      eventsFilterForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const formData = new FormData(eventsFilterForm);
        eventsState.filters.source = (formData.get('source') || '').trim();
        eventsState.filters.eventType = (formData.get('event_type') || '').trim();
        eventsState.filters.signatureValid = formData.get('signature_valid') || '';

        const start = formData.get('start_time');
        const end = formData.get('end_time');
        eventsState.filters.startTime = start ? new Date(start).toISOString() : '';
        eventsState.filters.endTime = end ? new Date(end).toISOString() : '';
        eventsState.pageSize = Number(formData.get('page_size')) || 20;
        eventsState.page = 1;
        loadEvents();
      });

      resetEventsFiltersBtn.addEventListener('click', () => {
        eventsState.filters = { source: '', eventType: '', signatureValid: '', startTime: '', endTime: '' };
        eventsState.page = 1;
        eventsState.pageSize = 20;
        eventsFilterForm.reset();
        loadEvents();
      });

      eventsSelectAll.addEventListener('change', () => {
        const shouldSelect = eventsSelectAll.checked;
        eventsState.items.forEach((item) => {
          if (shouldSelect) {
            eventsState.selected.add(item.id);
          } else {
            eventsState.selected.delete(item.id);
          }
        });
        renderEvents();
      });

      dlqSelectAll.addEventListener('change', () => {
        const shouldSelect = dlqSelectAll.checked;
        dlqState.items.forEach((item) => {
          if (shouldSelect) {
            dlqState.selected.add(item.id);
          } else {
            dlqState.selected.delete(item.id);
          }
        });
        renderDlq();
      });

      if (dlqFilterForm) {
        dlqFilterForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const formData = new FormData(dlqFilterForm);
          dlqState.filters.source = (formData.get('source') || '').toString().trim();
          dlqState.filters.eventType = (formData.get('event_type') || '').toString().trim();
          dlqState.filters.search = (formData.get('search') || '').toString().trim();
          const minRetryRaw = (formData.get('min_retry') || '').toString().trim();
          dlqState.filters.minRetry = minRetryRaw === '' ? '' : Math.max(0, Number(minRetryRaw) || 0);
          dlqState.page = 1;
          persistDlqState();
          loadDlq();
        });
      }

      if (resetDlqFiltersBtn) {
        resetDlqFiltersBtn.addEventListener('click', () => {
          dlqState.filters = { source: '', eventType: '', search: '', minRetry: '' };
          dlqState.page = 1;
          dlqState.pageSize = 20;
          if (dlqFilterForm) dlqFilterForm.reset();
          persistDlqState();
          loadDlq();
        });
      }

      bulkReplayEventsBtn.addEventListener('click', async () => {
        if (eventsState.selected.size === 0) return;
        const ids = Array.from(eventsState.selected);
        setButtonLoading(bulkReplayEventsBtn, true);
        try {
          const body = {
            ids,
          };
          if (bulkEventsTargetInput.value) {
            body.target_url = bulkEventsTargetInput.value;
          }
          const result = await fetchJson('/api/events/replay/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
          result.success_ids.forEach((id) => eventsState.selected.delete(id));
          const failedEntries = Object.entries(result.failed || {});
          const noteEntries = Object.entries(result.notes || {});
          const parts = [];
          if (result.success_ids.length) {
            parts.push(`æˆåŠŸ ${result.success_ids.length} æ¡`);
          }
          if (noteEntries.length) {
            const preview = noteEntries
              .slice(0, 3)
              .map(([id, message]) => `#${id} ${message}`)
              .join('ï¼›');
            parts.push(`è·³è¿‡ ${noteEntries.length} æ¡ï¼ˆ${preview}${noteEntries.length > 3 ? 'â€¦' : ''}ï¼‰`);
          }
          if (failedEntries.length) {
            const preview = failedEntries
              .slice(0, 3)
              .map(([id, message]) => `#${id} ${message}`)
              .join('ï¼›');
            parts.push(`å¤±è´¥ ${failedEntries.length} æ¡ï¼ˆ${preview}${failedEntries.length > 3 ? 'â€¦' : ''}ï¼‰`);
          }
          const variant = failedEntries.length ? 'error' : 'success';
          showStatus(parts.join(' / ') || 'æ‰¹é‡é‡æ”¾å·²å¤„ç†ã€‚', variant);
          loadEvents();
          loadDlq();
          loadStats();
        } catch (error) {
          showStatus(error.message || 'æ‰¹é‡é‡æ”¾å¤±è´¥', 'error');
        } finally {
          setButtonLoading(bulkReplayEventsBtn, false);
        }
      });

      bulkReplayDlqBtn.addEventListener('click', async () => {
        if (dlqState.selected.size === 0) return;
        const ids = Array.from(dlqState.selected);
        setButtonLoading(bulkReplayDlqBtn, true);
        try {
          const result = await fetchJson('/api/dlq/replay/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids }),
          });
          result.success_ids.forEach((id) => dlqState.selected.delete(id));
          const failedEntries = Object.entries(result.failed || {});
          const noteEntries = Object.entries(result.notes || {});
          const parts = [];
          if (result.success_ids.length) {
            parts.push(`æˆåŠŸ ${result.success_ids.length} æ¡`);
          }
          if (noteEntries.length) {
            const preview = noteEntries
              .slice(0, 3)
              .map(([id, message]) => `DLQ-${id} ${message}`)
              .join('ï¼›');
            parts.push(`è·³è¿‡ ${noteEntries.length} æ¡ï¼ˆ${preview}${noteEntries.length > 3 ? 'â€¦' : ''}ï¼‰`);
          }
          if (failedEntries.length) {
            const preview = failedEntries
              .slice(0, 3)
              .map(([id, message]) => `DLQ-${id} ${message}`)
              .join('ï¼›');
            parts.push(`å¤±è´¥ ${failedEntries.length} æ¡ï¼ˆ${preview}${failedEntries.length > 3 ? 'â€¦' : ''}ï¼‰`);
          }
          const summary = parts.length ? parts.join(' / ') : 'æ­»ä¿¡æ‰¹é‡é‡æ”¾å·²å¤„ç†ã€‚';
          const variant = failedEntries.length ? 'error' : 'success';
          showStatus(summary, variant);
          loadEvents();
          loadDlq();
          loadStats();
        } catch (error) {
          showStatus(error.message || 'æ‰¹é‡é‡æ”¾æ­»ä¿¡å¤±è´¥', 'error');
        } finally {
          setButtonLoading(bulkReplayDlqBtn, false);
        }
      });

      bulkDeleteDlqBtn.addEventListener('click', async () => {
        if (dlqState.selected.size === 0) return;
        if (!confirm('ç¡®å®šåˆ é™¤é€‰ä¸­çš„æ­»ä¿¡å—ï¼Ÿ')) return;
        const ids = Array.from(dlqState.selected);
        setButtonLoading(bulkDeleteDlqBtn, true);
        try {
          for (const id of ids) {
            await fetchJson(`/api/dlq/${id}`, { method: 'DELETE' });
            dlqState.selected.delete(id);
          }
          showStatus(`å·²åˆ é™¤ ${ids.length} æ¡æ­»ä¿¡ã€‚`);
          loadDlq();
          loadStats();
        } catch (error) {
          showStatus(error.message || 'æ‰¹é‡åˆ é™¤æ­»ä¿¡å¤±è´¥', 'error');
        } finally {
          setButtonLoading(bulkDeleteDlqBtn, false);
        }
      });

      clearDlqBtn.addEventListener('click', async () => {
        if (!confirm('ç¡®å®šæ¸…ç©ºæ­»ä¿¡é˜Ÿåˆ—å—ï¼Ÿ')) return;
        setButtonLoading(clearDlqBtn, true);
        try {
          const result = await fetchJson('/api/dlq/clear', { method: 'POST' });
          dlqState.selected.clear();
          showStatus(`å·²æ¸…ç©ºæ­»ä¿¡é˜Ÿåˆ—ï¼ˆå…± ${result.cleared} æ¡ï¼‰ã€‚`);
          loadDlq();
          loadStats();
        } catch (error) {
          showStatus(error.message || 'æ¸…ç©ºæ­»ä¿¡é˜Ÿåˆ—å¤±è´¥', 'error');
        } finally {
          setButtonLoading(clearDlqBtn, false);
        }
      });

      refreshEventsBtn.addEventListener('click', loadEvents);
      refreshDlqBtn.addEventListener('click', loadDlq);

      syncEventsFilterForm();
      syncDlqFilterForm();
      loadEvents();
      loadDlq();
      loadStats();
    </script>
  </body>
</html>


