<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-900" data-default-lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title data-i18n="page.title">Global Price Sentinel ¬∑ Scheduler & Alerts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .lang-switcher {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 50;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
      }
      .lang-toggle {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.65);
        color: #e2e8f0;
        font-weight: 600;
        letter-spacing: 0.03em;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .lang-toggle:hover,
      .lang-toggle:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.45);
        outline: none;
      }
      .lang-options {
        display: none;
        flex-direction: column;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.85);
        backdrop-filter: blur(16px);
        overflow: hidden;
      }
      .lang-options.open { display: flex; }
      .lang-option {
        padding: 10px 16px;
        color: #e2e8f0;
        font-size: 0.9rem;
        text-align: left;
        border: none;
        background: transparent;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .lang-option:hover,
      .lang-option:focus-visible,
      .lang-option.active {
        background: rgba(59, 130, 246, 0.35);
        outline: none;
      }
    </style>
  </head>
  <body class="h-full text-slate-100">
    <div class="lang-switcher" role="navigation" aria-label="Language selector">
      <button id="langToggle" class="lang-toggle" type="button" aria-expanded="false">
        <span>üåê</span><span data-i18n="lang.toggle">English</span>
      </button>
      <div id="langOptions" class="lang-options" role="menu">
        <button class="lang-option" data-lang="en" role="menuitemradio" aria-checked="true">English</button>
        <button class="lang-option" data-lang="zh" role="menuitemradio" aria-checked="false">‰∏≠Êñá</button>
      </div>
    </div>

    <main class="mx-auto flex min-h-full w-full max-w-4xl flex-col gap-8 px-4 py-10 sm:px-6 lg:px-8">
      <header class="space-y-3">
        <h1 class="text-3xl font-bold tracking-tight" data-i18n="page.title">Global Price Sentinel ¬∑ Scheduler & Alerts</h1>
        <p class="max-w-2xl text-base text-slate-300" data-i18n="page.intro">
          Configure schedule cadence, proxy pool and alert channels. All changes apply immediately; the scheduler must restart to adopt new cron plans.
        </p>
        <a href="/" class="inline-flex items-center gap-2 text-sm text-blue-300 underline hover:text-blue-200" aria-label="Back to portal" data-i18n="page.back">
          ‚Üê Back to portfolio portal
        </a>
      </header>

      <section aria-live="polite" id="status" class="hidden rounded-lg border border-slate-700 bg-slate-800/50 p-4 text-sm text-slate-200"></section>

      <section class="space-y-4 rounded-2xl border border-slate-700 bg-slate-800/50 p-6" aria-label="Scheduler status" id="scheduler-section">
        <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-lg font-semibold" data-i18n="scheduler.title">Scheduler Overview</h2>
            <p class="text-xs text-slate-400" data-i18n="scheduler.subtitle">Monitor latest executions and next planned run to debug quickly.</p>
          </div>
          <button id="refreshSchedulerStatus" class="self-start rounded-full bg-slate-700 px-4 py-2 text-xs font-semibold text-white transition hover:bg-slate-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900" data-i18n="scheduler.refresh">
            Refresh Status
          </button>
        </header>
        <div id="schedulerStatus" class="space-y-4 text-sm">
          <div class="grid gap-4 rounded-xl border border-slate-700 bg-slate-900/60 p-4 sm:grid-cols-2" role="group" aria-label="Scheduler summary">
            <div class="space-y-1">
              <p class="text-xs text-slate-400" data-i18n="scheduler.next">Next run</p>
              <p class="text-base font-semibold" id="nextRunDisplay">--</p>
              <p class="text-xs text-slate-500" id="nextRunCountdown"></p>
            </div>
            <div class="space-y-1">
              <p class="text-xs text-slate-400" data-i18n="scheduler.last">Last execution</p>
              <div id="lastRunSummary" class="text-sm" data-i18n="scheduler.empty">No executions yet</div>
            </div>
          </div>
          <div>
            <h3 class="mb-2 text-xs font-semibold uppercase tracking-wider text-slate-400" data-i18n="scheduler.recent">Recent run history</h3>
            <div class="overflow-x-auto rounded-xl border border-slate-700">
              <table class="min-w-full divide-y divide-slate-800 text-xs">
                <thead class="bg-slate-900/80 text-slate-400">
                  <tr>
                    <th class="px-4 py-2 text-left" data-i18n="scheduler.table.start">Start</th>
                    <th class="px-4 py-2 text-left" data-i18n="scheduler.table.end">End</th>
                    <th class="px-4 py-2 text-left" data-i18n="scheduler.table.duration">Duration</th>
                    <th class="px-4 py-2 text-left" data-i18n="scheduler.table.status">Status</th>
                    <th class="px-4 py-2 text-left" data-i18n="scheduler.table.message">Message</th>
                  </tr>
                </thead>
                <tbody id="recentRunsBody" class="divide-y divide-slate-800 text-slate-200">
                  <tr>
                    <td class="px-4 py-3 text-center text-slate-400" colspan="5" data-i18n="scheduler.empty">No executions yet</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <form id="config-form" class="space-y-10" novalidate>
        <fieldset class="space-y-4 rounded-2xl border border-slate-700 bg-slate-800/50 p-6">
          <legend class="px-2 text-lg font-semibold" data-i18n="forms.scheduler.legend">Scheduler</legend>
          <div class="grid gap-6 md:grid-cols-2">
            <div class="space-y-3">
              <span class="text-sm font-medium" data-i18n="forms.scheduler.mode">Scheduler Mode</span>
              <div class="flex flex-col gap-2 text-sm">
                <label class="flex items-center gap-2">
                  <input type="radio" name="schedulerMode" value="cron" class="h-4 w-4" />
                  <span data-i18n="forms.scheduler.modeCron">Use Cron expression (default every 12 hours)</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="radio" name="schedulerMode" value="interval" class="h-4 w-4" />
                  <span data-i18n="forms.scheduler.modeInterval">Custom interval (minutes)</span>
                </label>
              </div>
            </div>
            <div class="space-y-3">
              <label for="cronExpression" class="text-sm font-medium" data-i18n="forms.scheduler.cron">Cron Expression</label>
              <input id="cronExpression" name="cronExpression" type="text" class="w-full rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" placeholder="0 */12 * * *" aria-describedby="cron-help" />
              <p id="cron-help" class="text-xs text-slate-400" data-i18n="forms.scheduler.cronHelp">5-field cron expression: minute hour day month weekday.</p>
            </div>
            <div class="space-y-3 md:col-span-2">
              <label for="intervalMinutes" class="text-sm font-medium" data-i18n="forms.scheduler.interval">Interval (minutes)</label>
              <input id="intervalMinutes" name="intervalMinutes" type="number" min="5" max="1440" step="5" class="w-full rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" aria-describedby="interval-help" />
              <p id="interval-help" class="text-xs text-slate-400" data-i18n="forms.scheduler.intervalHelp">Valid when interval mode is selected, range 5 ‚Äì 1440 minutes.</p>
            </div>
          </div>
        </fieldset>

        <fieldset class="space-y-4 rounded-2xl border border-slate-700 bg-slate-800/50 p-6">
          <legend class="px-2 text-lg font-semibold" data-i18n="forms.proxy.legend">Proxy Pool</legend>
          <div class="space-y-4">
            <label class="flex items-center gap-2 text-sm font-medium">
              <input type="checkbox" id="proxyEnabled" class="h-4 w-4" />
              <span data-i18n="forms.proxy.toggle">Enable proxy pool (for distributed scraping & anti-bot bypass)</span>
            </label>
            <div class="grid gap-4 md:grid-cols-3" id="proxyFields">
              <div class="space-y-2">
                <label for="proxyServer" class="text-sm font-medium" data-i18n="forms.proxy.server">Proxy Server</label>
                <input id="proxyServer" type="text" class="w-full rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" placeholder="http://proxy:8080" />
              </div>
              <div class="space-y-2">
                <label for="proxyUsername" class="text-sm font-medium" data-i18n="forms.proxy.username">Username</label>
                <input id="proxyUsername" type="text" class="w-full rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" />
              </div>
              <div class="space-y-2">
                <label for="proxyPassword" class="text-sm font-medium" data-i18n="forms.proxy.password">Password</label>
                <input id="proxyPassword" type="password" class="w-full rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" />
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset class="space-y-4 rounded-2xl border border-slate-700 bg-slate-800/50 p-6">
          <legend class="px-2 text-lg font-semibold" data-i18n="forms.alerts.legend">Alert Channels</legend>
          <p class="text-sm text-slate-300" data-i18n="forms.alerts.description">Enable any channel you need. All alerts are logged for auditing.</p>
          <div class="grid gap-6 md:grid-cols-2">
            <div class="space-y-3">
              <label class="flex items-center gap-2 text-sm font-medium">
                <input type="checkbox" id="emailEnabled" class="h-4 w-4" />
                <span data-i18n="forms.alerts.email">Email Alert</span>
              </label>
              <label for="emailRecipients" class="sr-only">Email</label>
              <textarea id="emailRecipients" class="h-24 w-full rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" placeholder="Recipients, comma separated" data-i18n-placeholder="forms.alerts.emailPlaceholder"></textarea>
              <button type="button" id="testEmail" class="inline-flex items-center gap-2 rounded-lg border border-slate-600 px-3 py-1.5 text-xs text-slate-200 hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900" data-i18n="forms.alerts.emailTest">
                Test Email
              </button>
            </div>
            <div class="space-y-3">
              <label class="flex items-center gap-2 text-sm font-medium">
                <input type="checkbox" id="slackEnabled" class="h-4 w-4" />
                <span data-i18n="forms.alerts.slack">Slack Webhook</span>
              </label>
              <label for="slackWebhook" class="sr-only">Slack</label>
              <input id="slackWebhook" type="url" class="w-full rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" placeholder="https://hooks.slack.com/..." data-i18n-placeholder="forms.alerts.slackPlaceholder" />
              <button type="button" id="testSlack" class="inline-flex items-center gap-2 rounded-lg border border-slate-600 px-3 py-1.5 text-xs text-slate-200 hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900" data-i18n="forms.alerts.slackTest">
                Test Slack
              </button>
            </div>
            <div class="space-y-3 md:col-span-2">
              <label class="flex items-center gap-2 text-sm font-medium">
                <input type="checkbox" id="webhookEnabled" class="h-4 w-4" />
                <span data-i18n="forms.alerts.webhook">Custom Webhook</span>
              </label>
              <label for="genericWebhook" class="sr-only">Webhook</label>
              <input id="genericWebhook" type="url" class="w-full rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400" placeholder="https://example.com/alert" data-i18n-placeholder="forms.alerts.webhookPlaceholder" />
              <button type="button" id="testWebhook" class="inline-flex items-center gap-2 rounded-lg border border-slate-600 px-3 py-1.5 text-xs text-slate-200 hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900" data-i18n="forms.alerts.webhookTest">
                Test Webhook
              </button>
            </div>
          </div>
        </fieldset>

        <div class="flex items-center gap-4">
          <button type="submit" class="inline-flex items-center justify-center rounded-full bg-blue-500 px-6 py-2 text-sm font-semibold text-white transition hover:bg-blue-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900" data-i18n="forms.submit">
            Save Configuration
          </button>
          <span class="text-xs text-slate-400" data-i18n="forms.submitHint">Applies immediately for manual runs; scheduled jobs require restart.</span>
        </div>
      </form>
    </main>

    <script>
      (function () {
        const LANG_STORAGE_KEY = 'portfolio-lang';
        const SUPPORTED_LANGS = ['en', 'zh'];
        const defaultLang = document.documentElement.dataset.defaultLang || 'en';
        let currentLang = defaultLang;
        let translations = {};
        const cache = new Map();

        const langToggle = document.getElementById('langToggle');
        const langOptions = document.getElementById('langOptions');
        const langButtons = langOptions.querySelectorAll('.lang-option');

        async function fetchJson(url) {
          const res = await fetch(url, { cache: 'no-cache' });
          if (!res.ok) throw new Error(`Failed to fetch ${url}`);
          return res.json();
        }

        async function loadTranslations(lang) {
          if (cache.has(lang)) {
            translations = cache.get(lang);
            currentLang = lang;
            return;
          }
          const data = await fetchJson(`/i18n/p1.${lang}.json`);
          cache.set(lang, data);
          translations = data;
          currentLang = lang;
        }

        function t(path, fallback) {
          return path.split('.').reduce((acc, key) => acc && acc[key] !== undefined ? acc[key] : undefined, translations) ?? fallback;
        }

        function setText(el, key) {
          const value = t(key);
          if (value !== undefined) el.textContent = value;
        }

        function setPlaceholder(el, key) {
          const value = t(key);
          if (value !== undefined) el.setAttribute('placeholder', value);
        }

        function applyTranslations() {
          document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            setText(el, key);
          });

          document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            setPlaceholder(el, key);
          });

          document.title = t('page.title', document.title);
          document.documentElement.setAttribute('lang', currentLang === 'zh' ? 'zh-CN' : 'en');

          const toggleLabel = langToggle.querySelector('[data-i18n="lang.toggle"]');
          if (toggleLabel) setText(toggleLabel, 'lang.toggle');
          langButtons.forEach(btn => {
            const lang = btn.dataset.lang;
            const label = t(`lang.options.${lang}`, btn.textContent);
            btn.textContent = label;
            const isActive = lang === currentLang;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-checked', isActive ? 'true' : 'false');
          });
        }

        async function changeLanguage(lang, persist = true) {
          const target = SUPPORTED_LANGS.includes(lang) ? lang : 'en';
          await loadTranslations(target);
          applyTranslations();
          if (persist) {
            localStorage.setItem(LANG_STORAGE_KEY, target);
            document.cookie = `portfolio_lang=${target}; path=/; max-age=${60 * 60 * 24 * 365}`;
          }
          currentLang = target;
        }

        function initLanguage() {
          const stored = localStorage.getItem(LANG_STORAGE_KEY);
          if (stored && SUPPORTED_LANGS.includes(stored)) {
            return stored;
          }
          if (SUPPORTED_LANGS.includes(defaultLang)) {
            return defaultLang;
          }
          const nav = (navigator.language || navigator.languages?.[0] || 'en').toLowerCase();
          return nav.startsWith('zh') ? 'zh' : 'en';
        }

        langToggle.addEventListener('click', () => {
          const open = langOptions.classList.toggle('open');
          langToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
        });

        langButtons.forEach(btn => {
          btn.addEventListener('click', async () => {
            langOptions.classList.remove('open');
            langToggle.setAttribute('aria-expanded', 'false');
            await changeLanguage(btn.dataset.lang, true);
          });
        });

        document.addEventListener('click', event => {
          if (!langOptions.contains(event.target) && event.target !== langToggle) {
            langOptions.classList.remove('open');
            langToggle.setAttribute('aria-expanded', 'false');
          }
        });

        window.addEventListener('storage', async event => {
          if (event.key === LANG_STORAGE_KEY && event.newValue && event.newValue !== currentLang) {
            await changeLanguage(event.newValue, false);
          }
        });

        // ÂàùÂßãÂåñËØ≠Ë®Ä
        const initialLang = initLanguage();
        changeLanguage(initialLang, false);

        // --------------------- ÂéüÊúâÂäüËÉΩËÑöÊú¨ ---------------------
        const form = document.getElementById('config-form');
        const statusEl = document.getElementById('status');
        const schedulerModeInputs = document.querySelectorAll('input[name="schedulerMode"]');
        const cronInput = document.getElementById('cronExpression');
        const intervalInput = document.getElementById('intervalMinutes');
        const proxyToggle = document.getElementById('proxyEnabled');
        const proxyFields = document.querySelectorAll('#proxyFields input');
        const refreshSchedulerBtn = document.getElementById('refreshSchedulerStatus');
        const recentRunsBody = document.getElementById('recentRunsBody');
        const nextRunDisplay = document.getElementById('nextRunDisplay');
        const nextRunCountdown = document.getElementById('nextRunCountdown');
        const lastRunSummary = document.getElementById('lastRunSummary');
        const testEmailBtn = document.getElementById('testEmail');
        const testSlackBtn = document.getElementById('testSlack');
        const testWebhookBtn = document.getElementById('testWebhook');

        function showStatus(message, variant = 'success') {
          statusEl.textContent = message;
          statusEl.classList.remove('hidden', 'border-green-500', 'text-green-200', 'border-red-500', 'text-red-200');
          if (variant === 'success') {
            statusEl.classList.add('border-green-500', 'text-green-200');
          } else {
            statusEl.classList.add('border-red-500', 'text-red-200');
          }
        }

        function toggleSchedulerFields(mode) {
          if (mode === 'cron') {
            cronInput.disabled = false;
            intervalInput.disabled = true;
          } else {
            cronInput.disabled = true;
            intervalInput.disabled = false;
          }
        }

        schedulerModeInputs.forEach((input) => {
          input.addEventListener('change', () => toggleSchedulerFields(input.value));
        });

        proxyToggle.addEventListener('change', () => {
          proxyFields.forEach((field) => {
            field.disabled = !proxyToggle.checked;
          });
        });

        async function loadSchedulerStatus() {
          try {
            const res = await fetch('/api/scheduler/status');
            if (!res.ok) throw new Error('Failed to load scheduler status');
            const data = await res.json();
            const nextRun = data.next_run_time ? new Date(data.next_run_time) : null;
            if (nextRun) {
              nextRunDisplay.textContent = nextRun.toLocaleString();
              const diff = Math.max(0, Math.floor((nextRun.getTime() - Date.now()) / 1000));
              const minutes = Math.floor(diff / 60);
              const seconds = diff % 60;
              nextRunCountdown.textContent = minutes > 0
                ? `${minutes} min ${seconds}s`
                : `${seconds}s`;
            } else {
              nextRunDisplay.textContent = '--';
              nextRunCountdown.textContent = '';
            }
            if (data.last_run) {
              lastRunSummary.textContent = `${new Date(data.last_run.started_at).toLocaleString()} ¬∑ ${data.last_run.status}`;
            } else {
              lastRunSummary.textContent = t('scheduler.empty', 'No executions yet');
            }
            if (Array.isArray(data.recent_runs) && data.recent_runs.length) {
              recentRunsBody.innerHTML = data.recent_runs.map((run) => `
                <tr>
                  <td class="px-4 py-3">${new Date(run.started_at).toLocaleString()}</td>
                  <td class="px-4 py-3">${run.finished_at ? new Date(run.finished_at).toLocaleString() : '--'}</td>
                  <td class="px-4 py-3">${run.duration_seconds != null ? `${run.duration_seconds}s` : '--'}</td>
                  <td class="px-4 py-3">${run.status}</td>
                  <td class="px-4 py-3">${run.message || ''}</td>
                </tr>`).join('');
            } else {
              recentRunsBody.innerHTML = `<tr><td class="px-4 py-3 text-center text-slate-400" colspan="5">${t('scheduler.empty', 'No executions yet')}</td></tr>`;
            }
          } catch (error) {
            console.error(error);
            showStatus(t('alerts.statsFailed', 'Stats loading failed'), 'error');
          }
        }

        async function loadConfig() {
          try {
            const res = await fetch('/api/config/monitor');
            if (!res.ok) throw new Error('Failed to load monitor config');
            const config = await res.json();
            if (config.scheduler_mode === 'cron') {
              schedulerModeInputs[0].checked = true;
              toggleSchedulerFields('cron');
            } else {
              schedulerModeInputs[1].checked = true;
              toggleSchedulerFields('interval');
            }
            cronInput.value = config.cron_expression || '';
            intervalInput.value = config.interval_minutes || '';
            proxyToggle.checked = Boolean(config.proxy_enabled);
            proxyFields.forEach((field) => {
              field.disabled = !proxyToggle.checked;
            });
            document.getElementById('proxyServer').value = config.proxy_server || '';
            document.getElementById('proxyUsername').value = config.proxy_username || '';
            document.getElementById('proxyPassword').value = config.proxy_password || '';
            document.getElementById('emailEnabled').checked = Boolean(config.email_enabled);
            document.getElementById('emailRecipients').value = config.email_recipients || '';
            document.getElementById('slackEnabled').checked = Boolean(config.slack_enabled);
            document.getElementById('slackWebhook').value = config.slack_webhook || '';
            document.getElementById('webhookEnabled').checked = Boolean(config.webhook_enabled);
            document.getElementById('genericWebhook').value = config.webhook_url || '';
          } catch (error) {
            console.error(error);
            showStatus(t('alerts.docsFailed', 'Failed to load configuration'), 'error');
          }
        }

        function validateForm() {
          const selectedMode = Array.from(schedulerModeInputs).find((input) => input.checked)?.value;
          if (selectedMode === 'cron' && !cronInput.value.trim()) {
            showStatus(t('forms.validation.cronRequired', 'Cron expression cannot be empty'), 'error');
            return false;
          }
          if (selectedMode === 'interval') {
            const interval = Number(intervalInput.value);
            if (Number.isNaN(interval) || interval < 5 || interval > 1440) {
              showStatus(t('forms.validation.intervalInvalid', 'Interval must be between 5 and 1440 minutes'), 'error');
              return false;
            }
          }
          return true;
        }

        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!validateForm()) return;
          const payload = {
            scheduler_mode: Array.from(schedulerModeInputs).find((input) => input.checked)?.value || 'cron',
            cron_expression: cronInput.value.trim(),
            interval_minutes: intervalInput.value ? Number(intervalInput.value) : null,
            proxy_enabled: proxyToggle.checked,
            proxy_server: document.getElementById('proxyServer').value,
            proxy_username: document.getElementById('proxyUsername').value,
            proxy_password: document.getElementById('proxyPassword').value,
            email_enabled: document.getElementById('emailEnabled').checked,
            email_recipients: document.getElementById('emailRecipients').value,
            slack_enabled: document.getElementById('slackEnabled').checked,
            slack_webhook: document.getElementById('slackWebhook').value,
            webhook_enabled: document.getElementById('webhookEnabled').checked,
            webhook_url: document.getElementById('genericWebhook').value,
          };

          try {
            showStatus(t('toast.loading', 'Processing...'), 'success');
            const res = await fetch('/api/config/monitor', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            if (!res.ok) throw new Error(await res.text());
            showStatus(t('toast.saved', 'Configuration saved'), 'success');
          } catch (error) {
            console.error(error);
            showStatus(t('page.status.error', 'Operation failed: {error}').replace('{error}', error.message), 'error');
          }
        });

        async function testChannel(url, body) {
          try {
            const res = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body || {}),
            });
            if (!res.ok) throw new Error(await res.text());
            showStatus(t('toast.tested', 'Test request sent'), 'success');
          } catch (error) {
            console.error(error);
            showStatus(t('toast.failed', 'Operation failed'), 'error');
          }
        }

        testEmailBtn.addEventListener('click', () => {
          testChannel('/api/alerts/test', {
            channel: 'email',
            payload: {
              recipients: document.getElementById('emailRecipients').value,
            },
          });
        });
        testSlackBtn.addEventListener('click', () => {
          testChannel('/api/alerts/test', {
            channel: 'slack',
            payload: {
              webhook: document.getElementById('slackWebhook').value,
            },
          });
        });
        testWebhookBtn.addEventListener('click', () => {
          testChannel('/api/alerts/test', {
            channel: 'webhook',
            payload: {
              url: document.getElementById('genericWebhook').value,
            },
          });
        });

        refreshSchedulerBtn.addEventListener('click', loadSchedulerStatus);

        loadConfig();
        loadSchedulerStatus();
      })();
    </script>
  </body>
</html>

